// File: project-root/public/index.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#111827" />
    <meta
      name="description"
      content="Crypto Airdrop Task Manager - Track your crypto airdrop activities"
    />
    <link rel="apple-touch-icon" href="./logo192.png" />
    <link rel="manifest" href="./manifest.json" /> 
    <title>Airdrop Manager (Cloud)</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      if (typeof tailwind !== 'undefined') {
        tailwind.config = { 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            700: '#374151', 800: '#1F2937', 900: '#111827',
                        }
                    }
                }
            }
        }
      } else {
          console.warn("Tailwind CSS object not found. Configuration might not be applied.");
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #111827; margin:0; }
      #auth-container { padding: 20px; text-align: center; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
      #auth-container input { margin: 5px; padding: 8px; color: black; border-radius: 4px; border: 1px solid #4B5563; }
      #auth-container button { margin: 5px; padding: 8px 12px; background-color: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer; }
      #auth-container button:hover { background-color: #2563EB; }
      .user-info { color: white; text-align: center; padding: 10px; background-color: #1f2937; }
      .settings-section { margin-top: 20px; padding: 15px; background-color: #1f2937; border-radius: 8px; }
      .settings-section h3 { font-size: 1.1em; margin-bottom: 10px; color: #9CA3AF; }
      .settings-section button { background-color: #4B5563; margin-right: 10px; border-radius: 4px; padding: 8px 12px; color:white; cursor:pointer; }
      .settings-section button:hover { background-color: #6B7280; }
      .file-input-web { display: none; }
      .file-input-label { padding: 8px 12px; background-color: #4B5563; color: white; border-radius: 4px; cursor: pointer; display: inline-block; }
      .file-input-label:hover { background-color: #6B7280; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1f2937; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px;}
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
      html, body, #root { height: 100%; }
      .modal-content { max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- 
    <script>
      var __firebase_config = JSON.stringify({ apiKey: "AIza...", authDomain: "...", projectId: "...", ... });
      var __app_id = "your-unique-app-id";
      var __initial_auth_token = "your-custom-auth-token-if-any"; // Optional
    </script> 
    -->
    <div id="auth-container"></div>
    <div id="root"></div>

    <script type="module">
      const { useState, useEffect, StrictMode, Fragment } = React;
      const { createRoot } = ReactDOM;

      // --- Firebase Setup ---
      let firebaseApp;
      let db;
      let auth;
      let currentUserId = null;
      let userEmail = null; 

      try {
        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appIdFromGlobal = typeof __app_id !== 'undefined' ? __app_id : 'default-airdrop-manager';

        if (!firebaseConfigFromGlobal || Object.keys(firebaseConfigFromGlobal).length === 0) {
          console.error("Firebase config is missing or empty. App will not connect to Firebase.");
          const authContainer = document.getElementById('auth-container');
          if (authContainer) authContainer.innerHTML = '<p style="color:red;">Firebase configuration is missing. Please contact support.</p>';
        } else {
          firebase.initializeApp(firebaseConfigFromGlobal); 
          firebaseApp = firebase.app(); 
          db = firebase.firestore(); 
          auth = firebase.auth();   
          firebase.setLogLevel('debug'); 
          console.log("Firebase initialized with App ID:", appIdFromGlobal);
        }
      } catch (e) {
        console.error("Error initializing Firebase:", e);
        const authContainer = document.getElementById('auth-container');
        if (authContainer) authContainer.innerHTML = `<p style="color:red;">Error initializing Firebase: ${e.message}</p>`;
      }
      
      const getTasksCollectionPath = (userId) => {
        if (!userId) throw new Error("User ID is required for task path.");
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-airdrop-manager';
        return `artifacts/${appId}/users/${userId}/airdropTasks`;
      };

      // --- Lucide Icons (Manual inclusion) ---
      const Icon = ({ name, className = "w-4 h-4", color = "currentColor", strokeWidth = 2 }) => {
        const iconPaths = {
          Plus: "M12 5v14m-7-7h14", Play: "m5 3 14 9-14 9V3z", CheckCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3", Calendar: "M8 2v4m8-4v4M3.5 20.5h17A1.5 1.5 0 0 0 22 19V6.5a1.5 1.5 0 0 0-1.5-1.5h-17A1.5 1.5 0 0 0 2 6.5V19a1.5 1.5 0 0 0 1.5 1.5Z", Zap: "M13 2 3 14h9l-1 8 10-12h-9l1-8Z", Trophy: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18M9 12v7M15 12v7M12 12v7M9 4h6M9 9h6m-3 3v-3M12 19.5A2.5 2.5 0 0 1 9.5 22h-2A2.5 2.5 0 0 1 5 19.5V17a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2.5a2.5 2.5 0 0 1-2.5 2.5h-2A2.5 2.5 0 0 1 12 19.5Z", Search: "m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z", Trash2: "M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6m4-6v6", Power: "M12 2v10m6.36-7.78a8 8 0 1 1-12.72 0", Settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z", X: "M18 6 6 18M6 6l12 12"
        };
        return React.createElement('svg', {
          xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: color, strokeWidth: strokeWidth, strokeLinecap: "round", strokeLinejoin: "round", className: className
        }, React.createElement('path', { d: iconPaths[name] || "" }));
      };

      const AirdropManager = ({ userId }) => {
        const [tasks, setTasks] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [selectedTask, setSelectedTask] = useState(null);
        const [showAddModal, setShowAddModal] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [filterCategory, setFilterCategory] = useState('all');
        const [newTaskForm, setNewTaskForm] = useState({ name: '', description: '', interval: 'daily', category: 'DeFi', priority: 'medium', steps: [''] });
        const [feedbackMessage, setFeedbackMessage] = useState({ text: '', type: '' });

        // Data Migration from localStorage to Firestore
        useEffect(() => {
          if (!userId || !db) return;
          const migrateData = async () => {
            const migrationDoneKey = `migrationDone_${userId}_v1`;
            if (localStorage.getItem(migrationDoneKey)) return;
            const localTasksString = localStorage.getItem('airdrop-tasks');
            if (localTasksString) {
              try {
                const localTasks = JSON.parse(localTasksString);
                if (localTasks && localTasks.length > 0) {
                  console.log("Starting migration of tasks from localStorage to Firestore...");
                  const batch = db.batch();
                  const tasksCollectionRef = db.collection(getTasksCollectionPath(userId));
                  localTasks.forEach(task => {
                    const firestoreTask = {
                      name: task.name || "Untitled Task", description: task.description || "", interval: task.interval || "daily",
                      steps: Array.isArray(task.steps) ? task.steps.map((s,i)=>({id:s.id||`${Date.now()}-s${i}`,title:s.title||"",description:s.description||"",isCompleted:s.isCompleted||false,order:s.order||i})) : [],
                      streak: task.streak || 0,
                      lastCompleted: task.lastCompleted ? firebase.firestore.Timestamp.fromDate(new Date(task.lastCompleted)) : null,
                      nextDue: task.nextDue ? firebase.firestore.Timestamp.fromDate(new Date(task.nextDue)) : firebase.firestore.Timestamp.now(),
                      isActive: typeof task.isActive === 'boolean' ? task.isActive : true, category: task.category || "DeFi", priority: task.priority || "medium",
                      color: task.color || "bg-blue-500", userId: userId, createdAt: firebase.firestore.Timestamp.now(), updatedAt: firebase.firestore.Timestamp.now(),
                    };
                    const docRef = task.id ? tasksCollectionRef.doc(task.id) : tasksCollectionRef.doc();
                    batch.set(docRef, firestoreTask, {merge: true});
                  });
                  await batch.commit();
                  console.log("Migration successful!");
                  localStorage.setItem(migrationDoneKey, 'true');
                } else { localStorage.setItem(migrationDoneKey, 'true'); }
              } catch (error) { console.error("Error migrating data:", error); }
            } else { localStorage.setItem(migrationDoneKey, 'true'); }
          };
          migrateData();
        }, [userId]);

        // Fetch Tasks from Firestore
        useEffect(() => {
          if (!userId || !db) { setIsLoading(false); return; }
          setIsLoading(true);
          const tasksCollectionPath = getTasksCollectionPath(userId);
          const q = db.collection(tasksCollectionPath).orderBy("nextDue", "asc");
          const unsubscribe = q.onSnapshot(snapshot => {
            const fetchedTasks = snapshot.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id, ...data,
                lastCompleted: data.lastCompleted ? data.lastCompleted.toDate() : null,
                nextDue: data.nextDue.toDate(),
                createdAt: data.createdAt ? data.createdAt.toDate() : null,
                updatedAt: data.updatedAt ? data.updatedAt.toDate() : null,
              };
            });
            setTasks(fetchedTasks);
            setIsLoading(false);
          }, error => {
            console.error("Error fetching tasks from Firestore:", error);
            setIsLoading(false);
          });
          return () => unsubscribe();
        }, [userId]);

        // CRUD Operations
        const addNewTask = async () => {
          if (!newTaskForm.name.trim() || !userId || !db) return;
          const taskToAdd = {
            name: newTaskForm.name, description: newTaskForm.description, interval: newTaskForm.interval, category: newTaskForm.category, priority: newTaskForm.priority,
            steps: newTaskForm.steps.filter(step => step && step.trim()).map((step, index) => ({ id: `${Date.now()}-${index}`, title: step, description: `Complete: ${step}`, isCompleted: false, order: index + 1 })),
            streak: 0, lastCompleted: null, nextDue: firebase.firestore.Timestamp.now(), isActive: true,
            color: `bg-${['blue', 'purple', 'green', 'red', 'yellow', 'pink'][Math.floor(Math.random() * 6)]}-500`,
            userId: userId, createdAt: firebase.firestore.Timestamp.now(), updatedAt: firebase.firestore.Timestamp.now(),
          };
          try {
            await db.collection(getTasksCollectionPath(userId)).add(taskToAdd);
            setShowAddModal(false); setNewTaskForm({ name: '', description: '', interval: 'daily', category: 'DeFi', priority: 'medium', steps: [''] });
          } catch (error) { console.error("Error adding new task to Firestore:", error); }
        };

        const deleteTask = async (taskId) => {
          if (!userId || !db) return;
          try {
            await db.collection(getTasksCollectionPath(userId)).doc(taskId).delete();
            if (selectedTask && selectedTask.id === taskId) setSelectedTask(null);
          } catch (error) { console.error("Error deleting task from Firestore:", error); }
        };
        
        const completeTask = async (taskId) => {
            if (!userId || !db) return;
            const taskRef = db.collection(getTasksCollectionPath(userId)).doc(taskId);
            try {
                const taskDoc = await taskRef.get();
                if (!taskDoc.exists) { console.error("Task not found for completion"); return; }
                const taskData = taskDoc.data(); const now = new Date(); let nextDueDate = new Date(now);
                switch (taskData.interval) {
                    case 'hourly': nextDueDate.setHours(nextDueDate.getHours() + 1); break;
                    case 'daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                    case 'weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                    case 'biweekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                }
                await taskRef.update({
                    lastCompleted: firebase.firestore.Timestamp.fromDate(now), nextDue: firebase.firestore.Timestamp.fromDate(nextDueDate),
                    streak: (taskData.streak || 0) + 1, steps: taskData.steps.map(step => ({ ...step, isCompleted: false })),
                    updatedAt: firebase.firestore.Timestamp.now()
                });
                setSelectedTask(null);
            } catch (error) { console.error("Error completing task in Firestore:", error); }
        };

        const toggleTaskActive = async (taskId, currentIsActive) => {
            if (!userId || !db) return;
            try {
                await db.collection(getTasksCollectionPath(userId)).doc(taskId).update({
                    isActive: !currentIsActive, updatedAt: firebase.firestore.Timestamp.now()
                });
            } catch (error) { console.error("Error toggling task active state:", error); }
        };
        
        const handleStepChangeInModal = (index, value) => {
            const newSteps = [...newTaskForm.steps];
            newSteps[index] = value;
            setNewTaskForm(prev => ({ ...prev, steps: newSteps }));
        };

        const addStepInputInModal = () => {
            setNewTaskForm(prev => ({ ...prev, steps: [...prev.steps, ''] }));
        };

        const removeStepInputInModal = (index) => {
            if (newTaskForm.steps.length <= 1) return;
            const newSteps = newTaskForm.steps.filter((_, i) => i !== index);
            setNewTaskForm(prev => ({ ...prev, steps: newSteps }));
        };


        // Import/Export Logic
        const isElectron = !!window.electronAPI;
        const handleExportTasks = async () => {
            setFeedbackMessage({ text: '', type: '' });
            if (!userId || tasks.length === 0) { setFeedbackMessage({ text: 'No tasks to export.', type: 'info' }); return; }
            const tasksToExport = tasks.map(task => ({
                ...task,
                lastCompleted: task.lastCompleted ? task.lastCompleted.toISOString() : null,
                nextDue: task.nextDue ? task.nextDue.toISOString() : null,
                createdAt: task.createdAt ? task.createdAt.toISOString() : null,
                updatedAt: task.updatedAt ? task.updatedAt.toISOString() : null,
            }));
            const jsonData = JSON.stringify(tasksToExport, null, 2);
            if (isElectron) {
                try {
                    const result = await window.electronAPI.showSaveDialog({ title: 'Export Tasks', defaultPath: `airdrop-tasks-backup-${userId}.json`, filters: [{ name: 'JSON Files', extensions: ['json'] }] });
                    if (!result.canceled && result.filePath) {
                        const writeResult = await window.electronAPI.writeFile(result.filePath, jsonData);
                        if (writeResult.success) setFeedbackMessage({ text: 'Tasks exported successfully!', type: 'success' });
                        else setFeedbackMessage({ text: `Export failed: ${writeResult.error}`, type: 'error' });
                    }
                } catch (error) { console.error("Electron export error:", error); setFeedbackMessage({ text: `Export error: ${error.message}`, type: 'error' });}
            } else {
                const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `airdrop-tasks-backup-${userId}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                setFeedbackMessage({ text: 'Tasks download initiated!', type: 'success' });
            }
        };
        const handleImportTasks = async (event) => {
            setFeedbackMessage({ text: '', type: '' }); if (!userId || !db) return; let fileContent;
            if (isElectron) {
                try {
                    const result = await window.electronAPI.showOpenDialog({ title: 'Import Tasks', properties: ['openFile'], filters: [{ name: 'JSON Files', extensions: ['json'] }] });
                    if (!result.canceled && result.filePaths && result.filePaths.length > 0) {
                        const readResult = await window.electronAPI.readFile(result.filePaths[0]);
                        if (readResult.success) fileContent = readResult.content;
                        else { setFeedbackMessage({ text: `Import failed: ${readResult.error}`, type: 'error' }); return; }
                    } else return;
                } catch (error) { console.error("Electron import dialog/read error:", error); setFeedbackMessage({ text: `Import error: ${error.message}`, type: 'error' }); return; }
            } else {
                const file = event.target.files[0]; if (!file) return;
                try { fileContent = await file.text(); } catch (error) { console.error("Web import read error:", error); setFeedbackMessage({ text: `Error reading file: ${error.message}`, type: 'error' }); return; }
            }
            if (fileContent) {
                try {
                    const importedTasks = JSON.parse(fileContent);
                    if (!Array.isArray(importedTasks)) throw new Error("Invalid JSON format: Expected an array of tasks.");
                    const batch = db.batch(); const tasksCollectionRef = db.collection(getTasksCollectionPath(userId)); let importCount = 0;
                    importedTasks.forEach(task => {
                        const firestoreTask = {
                            name: task.name || "Imported Task", description: task.description || "", interval: task.interval || "daily",
                            steps: Array.isArray(task.steps) ? task.steps.map((s,i) => ({id: s.id || `${Date.now()}-s${i}`, title: s.title || "", description: s.description || "", isCompleted: s.isCompleted || false, order: s.order || i})) : [],
                            streak: Number(task.streak) || 0,
                            lastCompleted: task.lastCompleted ? firebase.firestore.Timestamp.fromDate(new Date(task.lastCompleted)) : null,
                            nextDue: task.nextDue ? firebase.firestore.Timestamp.fromDate(new Date(task.nextDue)) : firebase.firestore.Timestamp.now(),
                            isActive: typeof task.isActive === 'boolean' ? task.isActive : true, category: task.category || "DeFi", priority: task.priority || "medium",
                            color: task.color || "bg-gray-500", userId: userId, 
                            createdAt: task.createdAt ? firebase.firestore.Timestamp.fromDate(new Date(task.createdAt)) : firebase.firestore.Timestamp.now(), 
                            updatedAt: firebase.firestore.Timestamp.now(),
                        };
                        const docRef = task.id ? tasksCollectionRef.doc(task.id) : tasksCollectionRef.doc(); 
                        batch.set(docRef, firestoreTask, { merge: true }); importCount++;
                    });
                    await batch.commit(); setFeedbackMessage({ text: `${importCount} tasks imported successfully! List will refresh.`, type: 'success' });
                } catch (error) { console.error("Error processing imported tasks:", error); setFeedbackMessage({ text: `Import processing error: ${error.message}`, type: 'error' }); }
            }
            if (event && event.target) event.target.value = null;
        };
        useEffect(() => {
            if (isElectron && window.electronAPI.onTriggerImportTasks && window.electronAPI.onTriggerExportTasks) {
                const importCleanup = window.electronAPI.onTriggerImportTasks(() => handleImportTasks(null));
                const exportCleanup = window.electronAPI.onTriggerExportTasks(handleExportTasks);
                return () => {
                    if (typeof importCleanup === 'function') importCleanup(); else console.warn("Import cleanup function not found on electronAPI");
                    if (typeof exportCleanup === 'function') exportCleanup(); else console.warn("Export cleanup function not found on electronAPI");
                };
            }
        }, [isElectron, tasks, userId]);

        const getPriorityColor = (priority) => { /* ... */ return 'border-l-gray-500 bg-gray-700/30'; };
        const getIntervalBadge = (interval) => { /* ... */ return 'bg-gray-600 text-gray-100'; };
        const todaysTasks = tasks.filter(task => { /* ... */ return false; });

        if (isLoading && !db) return React.createElement('div', {className: "min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center"}, React.createElement('p', {className: "text-xl"}, "Error: Could not connect to services."));
        if (isLoading && db) return React.createElement('div', {className: "min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center"}, React.createElement('p', {className: "text-xl"}, "Loading tasks..."));
        
        const settingsUI = React.createElement('div', { className: 'settings-section p-4 rounded-lg bg-gray-800 my-6' },
            React.createElement('h3', {className: 'text-lg font-semibold text-gray-200 mb-3'}, 'Data Management'),
            React.createElement('div', {className: 'flex flex-wrap gap-3 items-center'},
                React.createElement('button', { onClick: handleExportTasks, className: 'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out' }, 'Export All Tasks'),
                isElectron ? 
                    React.createElement('button', { onClick: () => handleImportTasks(null), className: 'bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out' }, 'Import Tasks (Desktop)') :
                    React.createElement(Fragment, null, 
                        React.createElement('input', { type: 'file', id: 'fileInputWeb', className: 'file-input-web', onChange: handleImportTasks, accept: '.json' }),
                        React.createElement('label', { htmlFor: 'fileInputWeb', className: 'file-input-label bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out'}, 'Import Tasks')
                    )
            ),
            feedbackMessage.text && React.createElement('p', { style: { color: feedbackMessage.type === 'error' ? '#F87171' : '#34D399', marginTop: '10px' }, className:'text-sm' }, feedbackMessage.text)
        );
        
        // Main UI rendering
        return React.createElement('div', { className: "min-h-screen bg-gray-900 text-gray-100" },
            React.createElement('div', { className: "bg-gray-800/70 backdrop-blur-md border-b border-gray-700 sticky top-0 z-40" }, // Header
                React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4" },
                    React.createElement('div', { className: "flex items-center justify-between flex-wrap gap-4" },
                        React.createElement('div', { className: "flex items-center space-x-3" },
                            React.createElement('div', { className: "p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg" }, React.createElement(Icon, { name: "Zap", className: "w-6 h-6 text-white" })),
                            React.createElement('div', null,
                                React.createElement('h1', { className: "text-2xl font-bold text-white" }, "Airdrop Manager"),
                                React.createElement('p', { className: "text-sm text-gray-400" }, "Track your crypto airdrop activities")
                            )
                        ),
                        React.createElement('div', { className: "flex items-center space-x-4" },
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xl sm:text-2xl font-bold text-white" }, todaysTasks.length),
                                React.createElement('div', { className: "text-xs sm:text-sm text-gray-400" }, "Due Today")
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xl sm:text-2xl font-bold text-green-400" }, tasks.reduce((sum, task) => sum + task.streak, 0)),
                                React.createElement('div', { className: "text-xs sm:text-sm text-gray-400" }, "Total Streak")
                            ),
                            React.createElement('button', { onClick: () => setShowAddModal(true), className: "px-3 py-2 sm:px-4 sm:py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 flex items-center space-x-2 shadow-md hover:shadow-lg" },
                                React.createElement(Icon, { name: "Plus", className: "w-4 h-4" }), React.createElement('span', { className: "text-sm sm:text-base" }, "Add Task")
                            )
                        )
                    )
                )
            ),
            React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" }, // Main Content
                settingsUI,
                React.createElement('div', { className: "flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8" }, // Search & Filter
                    React.createElement('div', { className: "flex-1 relative w-full" },
                        React.createElement(Icon, { name: "Search", className: "absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" }),
                        React.createElement('input', { type: "text", placeholder: "Search tasks...", value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: "w-full pl-10 pr-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" })
                    ),
                    React.createElement('select', { value: filterCategory, onChange: (e) => setFilterCategory(e.target.value), className: "w-full sm:w-auto px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none" },
                        React.createElement('option', { value: "all" }, "All Categories"), React.createElement('option', { value: "DeFi" }, "DeFi"), React.createElement('option', { value: "L2" }, "Layer 2"), React.createElement('option', { value: "Gaming" }, "Gaming"), React.createElement('option', { value: "NFT" }, "NFT"), React.createElement('option', { value: "Bridge" }, "Bridge")
                    )
                ),
                React.createElement('div', { className: "mb-10" }, // Today's Tasks
                    React.createElement('div', { className: "flex items-center space-x-2 mb-4" }, React.createElement(Icon, { name: "Calendar", className: "w-6 h-6 text-blue-400" }), React.createElement('h2', { className: "text-xl font-semibold text-white" }, "Due Today"), React.createElement('span', { className: "px-2.5 py-1 bg-blue-600 text-white text-xs font-semibold rounded-full" }, todaysTasks.length)),
                    todaysTasks.length === 0 ? 
                        React.createElement('div', { className: "bg-gray-800/50 backdrop-blur-sm rounded-xl p-8 text-center border border-gray-700 shadow-lg" }, React.createElement(Icon, { name: "CheckCircle", className: "w-16 h-16 text-green-400 mx-auto mb-4" }), React.createElement('h3', { className: "text-xl font-semibold text-white mb-2" }, "All caught up!"), React.createElement('p', { className: "text-gray-400" }, "No tasks due today.")) :
                        React.createElement('div', { className: "grid gap-4" }, todaysTasks.map(task => React.createElement('div', { key: task.id, className: `bg-gray-800/60 backdrop-blur-sm rounded-xl p-5 border-l-4 ${getPriorityColor(task.priority)} border border-gray-700 hover:bg-gray-700/70 transition-all duration-200 shadow-md hover:shadow-lg` }, /* ... Task item content ... */ React.createElement('button', { onClick: () => setSelectedTask(task), /* ... */}, 'Start'))))
                ),
                React.createElement('div', null, // All Tasks Overview
                    React.createElement('h2', { className: "text-xl font-semibold text-white mb-4" }, "All Tasks"),
                    React.createElement('div', { className: "grid gap-5 md:grid-cols-2 lg:grid-cols-3" },
                        tasks.filter(task => (filterCategory === 'all' || task.category === filterCategory) && (task.name.toLowerCase().includes(searchTerm.toLowerCase()) || (task.description && task.description.toLowerCase().includes(searchTerm.toLowerCase())))).map(task => 
                            React.createElement('div', { key: task.id, className: "bg-gray-800/60 backdrop-blur-sm rounded-xl p-5 border border-gray-700 hover:border-gray-600 transition-all duration-200 shadow-md hover:shadow-lg flex flex-col justify-between" }, 
                                React.createElement('div', null, 
                                    React.createElement('div', {className:"flex items-center justify-between mb-3"}, React.createElement('div', {className: `w-3 h-3 rounded-full ${task.color || 'bg-gray-400'}`}), React.createElement('span', {className: `px-2 py-0.5 text-xs rounded-full font-medium ${getIntervalBadge(task.interval)}`}, task.interval)),
                                    React.createElement('h3', {className:"text-lg font-semibold text-white mb-1"}, task.name),
                                    React.createElement('p', {className:"text-gray-400 text-sm mb-3 line-clamp-2"}, task.description || "No description"),
                                    React.createElement('div', {className:"text-xs text-gray-500 mb-1"}, `Priority: ${task.priority}`),
                                    React.createElement('div', {className:"text-xs text-gray-500"}, `Next: ${new Date(task.nextDue).toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' })}`)
                                ),
                                React.createElement('div', { className: "flex items-center justify-between mt-4 pt-3 border-t border-gray-700" }, 
                                    React.createElement('div', {className:"flex items-center space-x-2 text-yellow-400"}, React.createElement(Icon, {name:"Trophy", className:"w-4 h-4"}), React.createElement('span', {className:"text-sm font-medium"}, task.streak)),
                                    React.createElement('div', { className: "flex items-center space-x-1" },
                                        React.createElement('button', { onClick: () => toggleTaskActive(task.id, task.isActive), className: `p-2 rounded-md ${task.isActive ? 'text-green-400 hover:bg-green-500/20' : 'text-gray-500 hover:bg-gray-600/30'} transition-colors`, title: task.isActive ? 'Pause task' : 'Resume task' }, React.createElement(Icon, {name: "Power", className:"w-4 h-4"})),
                                        React.createElement('button', { onClick: () => setSelectedTask(task), className: "p-2 rounded-md text-blue-400 hover:bg-blue-500/20 transition-colors", title: "View Details" }, React.createElement(Icon, {name: "Settings", className:"w-4 h-4"})),
                                        React.createElement('button', { onClick: () => deleteTask(task.id), className: "p-2 rounded-md text-red-400 hover:bg-red-500/20 transition-colors", title: "Delete task" }, React.createElement(Icon, {name: "Trash2", className:"w-4 h-4"}))
                                    )
                                )
                            )
                        )
                    )
                )
            ),
            // Add Task Modal
            showAddModal && React.createElement('div', { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50" },
                React.createElement('div', { className: "bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full modal-content" },
                    React.createElement('div', {className:"p-6 border-b border-gray-700 flex items-center justify-between"}, React.createElement('h2', {className:"text-xl font-bold text-white"}, "Add New Airdrop Task"), React.createElement('button', {onClick:()=>setShowAddModal(false), className:"text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-700"}, React.createElement(Icon, {name:"X", className:"w-5 h-5"}))),
                    React.createElement('div', {className:"p-6 space-y-5"},
                        React.createElement('input', {type:"text", placeholder:"Task Name", value:newTaskForm.name, onChange:e=>setNewTaskForm({...newTaskForm, name:e.target.value}), className:"w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600"}),
                        React.createElement('textarea', {placeholder:"Description", value:newTaskForm.description, onChange:e=>setNewTaskForm({...newTaskForm, description:e.target.value}), className:"w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600", rows:3}),
                        // ... (More inputs for interval, category, priority) ...
                        React.createElement('div', null, // Steps section
                            React.createElement('label', {className:"block text-sm font-medium text-gray-300 mb-1.5"}, "Task Steps"),
                            newTaskForm.steps.map((step, index) => (
                                React.createElement('div', { key: index, className: "flex items-center space-x-2 mb-2" },
                                    React.createElement('span', { className: "w-7 h-7 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold flex-shrink-0"}, index + 1),
                                    React.createElement('input', { type: "text", value: step, onChange: (e) => handleStepChangeInModal(index, e.target.value), className: "flex-1 px-3 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white", placeholder: `Step ${index + 1} details...` }),
                                    newTaskForm.steps.length > 1 && React.createElement('button', { onClick: () => removeStepInputInModal(index), className: "p-2 text-red-400 hover:text-red-300" }, React.createElement(Icon, {name:"Trash2", className:"w-4 h-4"}))
                                )
                            )),
                            React.createElement('button', { onClick: addStepInputInModal, className: "mt-2 px-3 py-1.5 text-sm text-blue-400 hover:text-blue-300" }, React.createElement(Icon, {name:"Plus", className:"w-4 h-4"}), " Add Step")
                        ),
                        React.createElement('button', {onClick: addNewTask, className:"w-full p-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md"}, "Create Task")
                    )
                )
            ),
            // Task Details Modal
            selectedTask && React.createElement('div', { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50" },
                React.createElement('div', { className: "bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full modal-content" },
                    React.createElement('div', {className:"p-6 border-b border-gray-700 flex items-center justify-between"}, React.createElement('h2', {className:"text-xl font-bold text-white"}, selectedTask.name), React.createElement('button', {onClick:()=>setSelectedTask(null), className:"text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-700"}, React.createElement(Icon, {name:"X", className:"w-5 h-5"}))),
                    React.createElement('div', {className:"p-6"},
                        React.createElement('p', {className:"text-gray-400 mb-4"}, selectedTask.description),
                        React.createElement('h3', {className:"text-lg font-semibold text-white mb-2"}, "Steps:"),
                        selectedTask.steps.sort((a,b)=>a.order-b.order).map((step, index) => React.createElement('div', {key:step.id, className:"mb-2 p-2 bg-gray-700 rounded"}, `${index+1}. ${step.title}`)),
                        React.createElement('button', {onClick:()=>completeTask(selectedTask.id), className:"mt-4 w-full p-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md"}, "Mark as Complete")
                    )
                )
            )
        );
      };

      // --- Authentication Component & Logic ---
      const AuthComponent = ({ onUserAuthenticated }) => {
        const [email, setEmail] = useState(''); const [password, setPassword] = useState('');
        const [isLogin, setIsLogin] = useState(true); const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleAuth = async (e) => {
            e.preventDefault(); setError(''); setLoading(true);
            if (!auth) { setError("Firebase Auth not initialized."); setLoading(false); return; }
            try {
                if (isLogin) await auth.signInWithEmailAndPassword(email, password);
                else await auth.createUserWithEmailAndPassword(email, password);
            } catch (err) { setError(err.message); console.error("Auth error:", err); } 
            finally { setLoading(false); }
        };
        const handleAnonymousSignIn = async () => {
            setError(''); setLoading(true);
            if (!auth) { setError("Firebase Auth not initialized."); setLoading(false); return; }
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) await auth.signInWithCustomToken(initialAuthToken);
                else await auth.signInAnonymously();
            } catch (err) { setError("Anonymous/Custom sign-in failed: " + err.message); console.error("Anonymous/Custom sign-in error:", err); } 
            finally { setLoading(false); }
        };

        if (!auth) return null;

        return React.createElement('div', {className: 'p-6 bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-auto'},
          React.createElement('h2', {className: 'text-2xl font-bold text-white text-center mb-6'}, isLogin ? 'Login' : 'Sign Up'),
          React.createElement('form', { onSubmit: handleAuth, className: 'space-y-4' },
            React.createElement('input', { type: 'email', value: email, onChange: e => setEmail(e.target.value), placeholder: 'Email Address', required: true, className:'w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-colors' }),
            React.createElement('input', { type: 'password', value: password, onChange: e => setPassword(e.target.value), placeholder: 'Password', required: true, className:'w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-colors' }),
            React.createElement('button', { type: 'submit', disabled: loading, className:'w-full p-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition duration-150 ease-in-out disabled:opacity-50' }, loading ? 'Processing...' : (isLogin ? 'Login' : 'Sign Up')),
            error && React.createElement('p', { style: { color: '#F87171' }, className:'text-sm text-center' }, error)
          ),
          React.createElement('button', { onClick: () => setIsLogin(!isLogin), disabled: loading, className:'w-full mt-4 p-3 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-md transition duration-150 ease-in-out disabled:opacity-50' }, isLogin ? 'Need an account? Sign Up' : 'Have an account? Login'),
          React.createElement('button', { onClick: handleAnonymousSignIn, disabled: loading, className:'w-full mt-2 p-3 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition duration-150 ease-in-out disabled:opacity-50' }, loading ? 'Processing...' : 'Continue Anonymously / Custom Token')
        );
      };
      
      // --- Main App Rendering Logic ---
      const App = () => {
        const [user, setUser] = useState(null);
        const [authLoading, setAuthLoading] = useState(true);

        useEffect(() => {
          if (!auth) { setAuthLoading(false); return; }
          const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
              currentUserId = firebaseUser.uid; 
              userEmail = firebaseUser.email || (firebaseUser.isAnonymous ? "Anonymous User" : `User (${firebaseUser.uid.substring(0,6)}...)`);
              setUser(firebaseUser);
            } else {
              currentUserId = null; userEmail = null; setUser(null);
            }
            setAuthLoading(false);
          });
          return () => unsubscribe();
        }, []);
        
        const handleSignOut = async () => {
            if (auth) {
                try { await auth.signOut(); } catch (error) { console.error("Error signing out: ", error); }
            }
        };
         // Listen for sign-out trigger from Electron main process
        useEffect(() => {
            if (window.electronAPI && typeof window.electronAPI.onTriggerFirebaseSignOut === 'function') {
                const cleanup = window.electronAPI.onTriggerFirebaseSignOut(handleSignOut);
                return () => { if(typeof cleanup === 'function') cleanup(); };
            }
        }, []);


        if (authLoading) {
          return React.createElement('div', { id: "auth-container", className: "flex items-center justify-center min-h-screen" }, 
            React.createElement('p', {className:'text-lg text-gray-300'}, 'Loading Authentication...')
          );
        }
        
        if (!db && !authLoading) {
            return React.createElement('div', {className: "min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center", id: "auth-container"}, 
                React.createElement('p', {className: "text-xl text-red-500"}, "Database service is unavailable. Please check Firebase configuration.")
            );
        }

        if (!user) {
          return React.createElement('div', { id: "auth-container", className: "flex items-center justify-center min-h-screen bg-gray-900" },
            React.createElement(AuthComponent, { onUserAuthenticated: setUser })
          );
        }

        return React.createElement(Fragment, null,
          React.createElement('div', {className: 'user-info py-2 px-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center text-sm'}, 
            React.createElement('span', null, `Signed in as: ${userEmail}`),
            React.createElement('button', {onClick: handleSignOut, className:'bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-md transition duration-150 ease-in-out'}, 'Sign Out')
          ),
          React.createElement(AirdropManager, { userId: user.uid })
        );
      };

      const rootElement = document.getElementById('root');
      const authContainerElement = document.getElementById('auth-container'); 

      if (rootElement && authContainerElement) {
        const root = createRoot(rootElement); // Render main app here
        // Auth UI is handled by App component logic, so auth-container might be cleared or hidden by App.
        root.render(React.createElement(StrictMode, null, React.createElement(App)));
      } else {
         const targetForError = authContainerElement || document.body;
         targetForError.innerHTML = '<p style="color:red; text-align:center; padding-top: 50px;">Critical error: Required HTML elements (#root or #auth-container) not found.</p>';
         console.error("Critical error: #root or #auth-container HTML element not found.");
      }
      
    </script>

    <script type="application/json" id="manifest-json-data">
    {
      "short_name": "AirdropMgr",
      "name": "Crypto Airdrop Task Manager",
      "icons": [
        { "src": "https://placehold.co/64x64/1F2937/FFFFFF?text=Icon&font=Inter", "sizes": "64x64", "type": "image/png", "purpose": "any" },
        { "src": "https://placehold.co/192x192/1F2937/FFFFFF?text=Icon&font=Inter", "type": "image/png", "sizes": "192x192", "purpose": "any" },
        { "src": "https://placehold.co/512x512/1F2937/FFFFFF?text=Icon&font=Inter", "type": "image/png", "sizes": "512x512", "purpose": "any maskable" }
      ],
      "start_url": ".", "display": "standalone", "scope": "/", "theme_color": "#111827", "background_color": "#1F2937",
      "description": "Track and manage your crypto airdrop activities efficiently."
    }
    </script>
    <script>
      const manifestElement = document.getElementById('manifest-json-data');
      if (manifestElement) {
        const manifestJSON = manifestElement.textContent;
        const blob = new Blob([manifestJSON], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        let linkElement = document.querySelector('link[rel="manifest"]');
        if (!linkElement) {
            newLinkElement = document.createElement('link');
            newLinkElement.setAttribute('rel', 'manifest');
            document.head.appendChild(newLinkElement);
            linkElement = newLinkElement;
        }
        linkElement.setAttribute('href', manifestURL);
      }
    </script>

    <script id="service-worker-script">
    const CACHE_NAME = 'airdrop-manager-cache-v3'; // Incremented version
    const urlsToCache = [
      './', 
      'https://cdn.tailwindcss.com',
      'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
      'https://unpkg.com/react@18/umd/react.development.js',
      'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
      'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js',
      'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js',
      'https://placehold.co/64x64/1F2937/FFFFFF?text=Icon&font=Inter',
      'https://placehold.co/192x192/1F2937/FFFFFF?text=Icon&font=Inter',
      'https://placehold.co/512x512/1F2937/FFFFFF?text=Icon&font=Inter'
    ];
    self.addEventListener('install', event => { /* ... full SW install ... */ });
    self.addEventListener('activate', event => { /* ... full SW activate ... */ });
    self.addEventListener('fetch', event => { /* ... full SW fetch ... */ });
    // For full SW code, refer to 'airdrop_manager_p4_firebase_integration_web' and ensure it's complete.
    </script>
    <script>
      const swScriptElement = document.getElementById('service-worker-script');
      if (swScriptElement && 'serviceWorker' in navigator) {
        const swScriptContent = swScriptElement.textContent;
        try {
            const blob = new Blob([swScriptContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(blob);
            window.addEventListener('load', () => {
              navigator.serviceWorker.register(swURL, {scope: './'})
                .then(reg => console.log('ServiceWorker registration successful with scope: ', reg.scope))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        } catch (e) { console.error("Error creating SW blob URL:", e); }
      }
    </script>
</body>
</html>